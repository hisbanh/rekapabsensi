{% extends 'base_new.html' %}
{% load attendance_extras %}

{% block title %}Input Absensi - SIPA Yaumi{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-header-content">
    <h1 class="page-title">Input Absensi</h1>
    <p class="page-subtitle">Kelola kehadiran siswa per jam pelajaran</p>
  </div>
</div>

<!-- Filter Bar -->
<div class="card mb-6">
  <div class="card-body">
    <div class="filter-bar">
      <div class="filter-bar-content">
        <!-- Date Filter -->
        <div class="filter-group">
          <div class="form-group">
            <label for="tanggal" class="form-label">Tanggal</label>
            <input type="date" 
                   id="tanggal" 
                   name="tanggal" 
                   class="form-control"
                   value="{{ date|date:'Y-m-d' }}"
                   onchange="updateDateFilter()">
          </div>
        </div>

        <!-- Class Filter -->
        <div class="filter-group">
          <div class="form-group">
            <label for="kelas" class="form-label">Kelas</label>
            <select id="kelas" name="kelas" class="form-select" onchange="updateClassFilter()">
              {% for classroom_option in classrooms %}
                <option value="{{ classroom_option.id }}"{% if classroom_option.id == classroom.id %} selected{% endif %}>
                  {{ classroom_option.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- JP Selector -->
        <div class="filter-group">
          <div class="form-group">
            <label class="form-label">Jam Pelajaran (JP)</label>
            <div class="jp-selector">
              {% for jp in jp_range %}
                <button type="button" 
                        class="btn btn-outline-primary jp-btn{% if jp == current_jp %} active{% endif %}" 
                        data-jp="{{ jp }}">
                  {{ jp }}
                </button>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="filter-bar-actions">
        <button type="button" class="btn btn-primary" data-action="save">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 .75.75Z" />
          </svg>
          Simpan JP {{ current_jp }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Class and Date Info -->
<div class="card mb-6">
  <div class="card-body">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="icon-circle bg-primary-100 text-primary-600">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.902 59.902 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443a55.38 55.38 0 0 1 5.25 2.882V15" />
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-slate-900">{{ classroom.full_name }}</h3>
          <p class="text-sm text-slate-500">{{ date|date:"l, d F Y" }}</p>
        </div>
      </div>
      <div class="text-right">
        <div class="text-2xl font-bold text-slate-900">{{ total_students }}</div>
        <div class="text-sm text-slate-500">Total Siswa</div>
      </div>
    </div>
  </div>
</div>

<!-- Holiday Warning -->
{% if is_holiday %}
<div class="alert alert-warning mb-6">
  <div class="flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
    </svg>
    <div>
      <strong>Perhatian:</strong> Tanggal ini adalah hari libur
      {% if holiday_info %}
        (<strong>{{ holiday_info.name }}</strong> - {{ holiday_info.get_holiday_type_display }})
      {% endif %}
      . Anda tetap dapat menginput absensi jika diperlukan.
    </div>
  </div>
</div>
{% endif %}

<!-- Attendance Table -->
{% if students_data %}
<div class="card">
  <div class="card-header">
    <div class="flex items-center justify-between">
      <h3 class="card-title">
        Presensi Jam Pelajaran {{ current_jp|default:1 }}
      </h3>
      <div class="text-sm text-slate-500">
        {{ date|date:"l, d F Y" }}
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th class="w-16">No</th>
            <th class="w-20">NIS</th>
            <th class="min-w-64">Nama Santri</th>
            <th class="w-48">Kehadiran (JP {{ current_jp|default:1 }})</th>
            <th class="min-w-48">Catatan</th>
          </tr>
        </thead>
        <tbody>
          {% for item in students_data %}
          <tr data-student-id="{{ item.student.id }}">
            <td class="text-center">{{ forloop.counter }}</td>
            <td class="text-center text-sm text-slate-500">
              {{ item.student.student_id|default:"-" }}
            </td>
            <td>
              <div class="flex items-center space-x-3">
                {% include 'components/_avatar.html' with name=item.student.name %}
                <div>
                  <div class="font-medium text-slate-900">{{ item.student.name }}</div>
                </div>
              </div>
            </td>
            <td>
              {% with current_status=item.jp_statuses.0.status %}
              {% include 'components/_status_badge.html' with student_id=item.student.id jp=current_jp current_status=current_status %}
              {% endwith %}
            </td>
            <td>
              <input type="text" 
                     class="form-control form-control-sm" 
                     placeholder="Catatan (opsional)"
                     data-student="{{ item.student.id }}"
                     data-jp="{{ current_jp|default:1 }}"
                     name="notes_{{ item.student.id }}_{{ current_jp|default:1 }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="card">
  <div class="card-body text-center py-12">
    <div class="icon-circle bg-slate-100 text-slate-400 mx-auto mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-slate-900 mb-2">Tidak ada siswa aktif</h3>
    <p class="text-slate-500 mb-6">Silakan tambahkan siswa ke kelas {{ classroom.full_name }} terlebih dahulu</p>
    <a href="{% url 'attendance_input' %}" class="btn btn-primary">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
      </svg>
      Kembali
    </a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Configuration
const classroomId = '{{ classroom.id }}';
const dateStr = '{{ date_str }}';
const currentJP = {{ current_jp|default:1 }};

// Initialize status badge functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeStatusBadges();
    initializeJPSelector();
    initializeSaveButton();
});

function initializeStatusBadges() {
    // Add click handlers to all status badges
    const statusBadges = document.querySelectorAll('.status-badge');
    statusBadges.forEach(badge => {
        badge.addEventListener('click', function() {
            handleStatusToggle(this);
        });
    });
}

function handleStatusToggle(clickedBadge) {
    const group = clickedBadge.closest('.status-badge-group');
    const studentId = group.dataset.student;
    const jp = group.dataset.jp;
    const newStatus = clickedBadge.dataset.status;
    
    // Remove active class from all badges in this group
    const allBadges = group.querySelectorAll('.status-badge');
    allBadges.forEach(badge => {
        badge.classList.remove('active');
    });
    
    // Add active class to clicked badge
    clickedBadge.classList.add('active');
    
    // Store the selection for later saving
    storeAttendanceSelection(studentId, jp, newStatus);
    
    // Visual feedback
    showStatusChangeAnimation(clickedBadge);
}

function storeAttendanceSelection(studentId, jp, status) {
    // Store in a global object for later saving
    if (!window.attendanceData) {
        window.attendanceData = {};
    }
    
    if (!window.attendanceData[studentId]) {
        window.attendanceData[studentId] = {};
    }
    
    window.attendanceData[studentId][jp] = status;
    
    console.log('Stored attendance:', studentId, jp, status);
}

function showStatusChangeAnimation(badge) {
    // Add a subtle animation to show the change
    badge.style.transform = 'scale(1.1)';
    setTimeout(() => {
        badge.style.transform = 'scale(1)';
    }, 150);
}

function initializeJPSelector() {
    // JP selector functionality
    const jpButtons = document.querySelectorAll('.jp-btn');
    jpButtons.forEach(button => {
        button.addEventListener('click', function() {
            const jp = this.dataset.jp;
            // Update URL to show selected JP
            const url = new URL(window.location);
            url.searchParams.set('jp', jp);
            window.location.href = url.toString();
        });
    });
}

function updateDateFilter() {
    const dateInput = document.getElementById('tanggal');
    const classSelect = document.getElementById('kelas');
    const newDate = dateInput.value;
    const classroomId = classSelect.value;
    
    if (newDate && classroomId) {
        // Redirect to new date
        window.location.href = `/attendance/input/${classroomId}/${newDate}/`;
    }
}

function updateClassFilter() {
    const dateInput = document.getElementById('tanggal');
    const classSelect = document.getElementById('kelas');
    const newClassroomId = classSelect.value;
    const currentDate = dateInput.value;
    
    if (newClassroomId && currentDate) {
        // Redirect to new classroom
        window.location.href = `/attendance/input/${newClassroomId}/${currentDate}/`;
    }
}

function initializeSaveButton() {
    // Find save button and add click handler
    const saveButton = document.querySelector('[data-action="save"]');
    if (saveButton) {
        saveButton.addEventListener('click', function() {
            saveAttendanceData();
        });
    }
}

function collectAttendanceData() {
    const attendanceData = [];
    
    // Get all student rows
    const studentRows = document.querySelectorAll('tbody tr[data-student-id]');
    
    studentRows.forEach(row => {
        const studentId = row.dataset.studentId;
        const statusGroup = row.querySelector('.status-badge-group');
        const activeStatus = statusGroup.querySelector('.status-badge.active');
        const notesInput = row.querySelector('input[data-student]');
        
        if (activeStatus) {
            const status = activeStatus.dataset.status;
            const notes = notesInput ? notesInput.value.trim() : '';
            
            attendanceData.push({
                student_id: studentId,
                jp: currentJP,
                status: status,
                notes: notes
            });
        }
    });
    
    return attendanceData;
}

function saveAttendanceData() {
    const attendanceData = collectAttendanceData();
    
    if (attendanceData.length === 0) {
        alert('Tidak ada data untuk disimpan');
        return;
    }
    
    // Show loading state
    const saveButton = document.querySelector('[data-action="save"]');
    if (saveButton) {
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<div class="spinner spinner-sm"></div> Menyimpan...';
        saveButton.disabled = true;
        
        // Prepare data for API
        const payload = {
            classroom_id: classroomId,
            date: dateStr,
            attendance: attendanceData.map(item => ({
                student_id: item.student_id,
                jp_statuses: {
                    [item.jp]: item.status
                },
                notes: item.notes
            }))
        };
        
        // Call API
        fetch('{% url "api_save_attendance" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                // Optionally reload the page to show updated data
                // window.location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error saving attendance:', error);
            alert('Terjadi kesalahan saat menyimpan data. Silakan coba lagi.');
        })
        .finally(() => {
            // Restore button state
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        });
    }
    
    console.log('Saving attendance data:', attendanceData);
}

// Initialize default status (H) for all students if no active status
function initializeDefaultStatuses() {
    const statusGroups = document.querySelectorAll('.status-badge-group');
    statusGroups.forEach(group => {
        const activeStatus = group.querySelector('.status-badge.active');
        if (!activeStatus) {
            // Set default to 'H' (Hadir)
            const hadirBadge = group.querySelector('.status-badge-h');
            if (hadirBadge) {
                hadirBadge.classList.add('active');
            }
        }
    });
}

// Call initialization after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeDefaultStatuses();
});
</script>
{% endblock %}